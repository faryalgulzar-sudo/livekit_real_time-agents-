services:
  # FastAPI Backend (LiveKit Token API)
  fastapi:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: agent786-fastapi
    working_dir: /app/backend/api
    environment:
      - LIVEKIT_URL=${LIVEKIT_URL:-ws://localhost:7880}
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      - ../backend/api:/app/backend/api
      - ../backend/agent:/app/backend/agent
    restart: unless-stopped
    network_mode: host

  # Database API Server
  database-api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: agent786-database-api
    working_dir: /app/backend/agent
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql://dentist:dentist_pass@localhost:5432/dentist_ai}
    command: uvicorn main:app --host 0.0.0.0 --port 8001 --reload
    volumes:
      - ../backend/agent:/app/backend/agent
    restart: unless-stopped
    network_mode: host
    depends_on:
      - fastapi

  # LiveKit Agent Worker
  agent:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: agent786-agent
    working_dir: /app
    runtime: nvidia
    environment:
      - LIVEKIT_URL=${LIVEKIT_URL:-ws://localhost:7880}
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen2.5:3b}
      - AGENT_API_BASE_URL=${AGENT_API_BASE_URL:-http://localhost:8001}
      - AGENT_API_TIMEOUT=5
      - AGENT_API_RETRIES=3
      - TENANT_ID=${TENANT_ID:-demo_clinic}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - HF_HOME=/app/.cache/huggingface  # Hugging Face cache location
    command: python backend/agent/agent.py dev
    volumes:
      - ../backend/agent:/app/backend/agent
      - huggingface-cache:/app/.cache/huggingface  # Persistent cache for models
    depends_on:
      - database-api
    restart: unless-stopped
    network_mode: host

  # Next.js Frontend
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: agent786-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=https://agent007.drap.ai
      - PORT=3000
    volumes:
      - ../frontend:/app
      - /app/node_modules
      - /app/.next
    networks:
      - agent786-network
    restart: unless-stopped

volumes:
  huggingface-cache:
    driver: local

networks:
  agent786-network:
    driver: bridge